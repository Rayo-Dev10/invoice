(()=>{const Items=[];let EditingIndex=-1;const USD="USD";const $=id=>document.getElementById(id);const todayISO=()=>{const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");return `${y}-${m}-${day}`};const parseNum=v=>{const s=String(v??"").trim().replaceAll(",","");const n=Number(s);return Number.isFinite(n)?n:NaN};const money=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:USD,minimumFractionDigits:2}).format(Number(n||0));const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");const totals=()=>Items.reduce((a,it)=>a+(it.qty*it.unitPrice),0);const FlowOrder=["InvoiceNumberInput","InvoiceDateInput","PaymentDueInput","BillToNameBoldInput","BillToLine1Input","BillToLine2Input","BillToLine3Input","BillToPhoneInput","BillToEmailInput"];const Confirmed=new Set();let Mode="wizard";let ActiveFlow=FlowOrder[0];const setMode=m=>{Mode=m;document.body.dataset.mode=m};const focusFlow=id=>{const el=$(id);if(!el)return;try{el.focus({preventScroll:true})}catch(_){try{el.focus()}catch(__){}}try{el.scrollIntoView({behavior:"smooth",block:"center"})}catch(_){}};const updateWrappers=()=>{FlowOrder.forEach(fid=>{const el=$(fid);if(!el)return;const w=el.closest(".flowwrap");const isActive=(Mode!=="idle"&&fid===ActiveFlow);if(w){w.classList.toggle("is-active",isActive);w.classList.toggle("is-confirmed",Confirmed.has(fid))}if("readOnly"in el)el.readOnly=!isActive;el.tabIndex=isActive?0:-1});const bar=$("MobileNextBar");if(bar)bar.style.display=(Mode==="idle"?"none":"")};const render=()=>{const tbody=$("ItemsBody");tbody.innerHTML="";if(!Items.length){tbody.innerHTML='<tr><td class="empty" colspan="4">Sin √≠tems. Usa ‚ÄúAgregar √≠tem‚Äù.</td></tr>'}else{Items.forEach((it,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td><div class="item-title-row"><div class="item-title">${esc(it.title)}</div><div class="item-actions"><button type="button" class="edit-btn" data-edit="${i}">Editar</button><button type="button" class="delete-btn" data-del="${i}" title="Eliminar √≠tem" aria-label="Eliminar √≠tem">üóëÔ∏è</button></div></div><div class="item-desc">${esc(it.desc).replaceAll("\n","<br>")}</div></td><td class="r">${it.qty}</td><td class="r">${money(it.unitPrice)}</td><td class="r">${money(it.qty*it.unitPrice)}</td>`;tbody.appendChild(tr)})}const t=totals();$("Total").textContent=money(t);$("AmountDueTop").textContent=money(t);$("AmountDueBottom").textContent=money(t)};const openEditorAdd=()=>{EditingIndex=-1;const h=document.querySelector("#Editor h3");if(h)h.textContent="Nuevo √≠tem";const b=$("BtnFinishDesc");if(b)b.textContent="Finalizar";$("Editor").style.display="block";$("ItemTitle").value="";$("ItemDesc").value="";try{$("Editor").scrollIntoView({behavior:"smooth",block:"start"})}catch(_){}$("ItemTitle").focus()};const closeEditor=()=>{$("Editor").style.display="none";EditingIndex=-1;const h=document.querySelector("#Editor h3");if(h)h.textContent="Nuevo √≠tem";const b=$("BtnFinishDesc");if(b)b.textContent="Finalizar"};const finishItem=()=>{const title=$("ItemTitle").value.trim();const desc=String($("ItemDesc").value??"").trim();if(!title){alert("Falta el t√≠tulo del √≠tem.");$("ItemTitle").focus();return}if(!desc){alert("Falta la descripci√≥n del √≠tem.");$("ItemDesc").focus();return}let defaultQty="1",defaultUnit="0";if(EditingIndex>=0&&Items[EditingIndex]){defaultQty=String(Items[EditingIndex].qty);defaultUnit=String(Items[EditingIndex].unitPrice)}let qty=parseNum(prompt("Cantidad (Quantity):",defaultQty));if(!Number.isFinite(qty)||qty<=0){alert("Cantidad inv√°lida.");return}let unit=parseNum(prompt(`Valor unitario (Unit Price) en ${USD} (solo n√∫mero):`,defaultUnit));if(!Number.isFinite(unit)||unit<0){alert("Valor unitario inv√°lido.");return}if(EditingIndex>=0){Items[EditingIndex]={title,desc,qty,unitPrice:unit};closeEditor();render();return}Items.push({title,desc,qty,unitPrice:unit});closeEditor();render()};const openEditorEdit=idx=>{const it=Items[idx];if(!it)return;EditingIndex=idx;const h=document.querySelector("#Editor h3");if(h)h.textContent="Editar √≠tem";const b=$("BtnFinishDesc");if(b)b.textContent="Guardar cambios";$("Editor").style.display="block";$("ItemTitle").value=it.title;$("ItemDesc").value=it.desc;try{$("Editor").scrollIntoView({behavior:"smooth",block:"start"})}catch(_){}$("ItemTitle").focus()};const delItem=idx=>{const it=Items[idx];if(!it)return;const ok=confirm(`¬øEliminar el √≠tem "${it.title}"?`);if(!ok)return;Items.splice(idx,1);if(EditingIndex===idx)closeEditor();else if(EditingIndex>idx)EditingIndex-=1;render()};const confirmActive=()=>{if(Mode==="idle"||!ActiveFlow)return;const id=ActiveFlow;const el=$(id);if(!el)return;let v=String(el.value??"").trim();if(id==="InvoiceNumberInput"&&!v){alert("Debe indicar un n√∫mero de factura");focusFlow(id);return}if((id==="InvoiceDateInput"||id==="PaymentDueInput")&&!v){el.value=todayISO();v=el.value}Confirmed.add(id);if(Mode==="wizard"){const idx=FlowOrder.indexOf(id);if(idx<FlowOrder.length-1){ActiveFlow=FlowOrder[idx+1];updateWrappers();focusFlow(ActiveFlow);return}setMode("idle");ActiveFlow=null;updateWrappers();openEditorAdd();return}if(Mode==="editheader"){setMode("idle");ActiveFlow=null;updateWrappers();return}};const editHeader=id=>{if(!Confirmed.has(id))return;setMode("editheader");ActiveFlow=id;updateWrappers();focusFlow(id)};$("InvoiceDateInput").value=todayISO();$("PaymentDueInput").value=todayISO();$("BtnAddGuided").addEventListener("click",()=>openEditorAdd());$("BtnCancel").addEventListener("click",()=>closeEditor());$("BtnFinishDesc").addEventListener("click",()=>finishItem());$("BtnPrint").addEventListener("click",()=>window.print());$("BtnNextField").addEventListener("click",()=>confirmActive());document.addEventListener("click",e=>{const ok=e.target.closest("button[data-ok]");if(ok){const id=ok.getAttribute("data-ok");if(Mode==="wizard"&&id!==ActiveFlow)return;ActiveFlow=id;confirmActive();return}const ed=e.target.closest("button[data-editfield]");if(ed){const id=ed.getAttribute("data-editfield");editHeader(id);return}const itEdit=e.target.closest("button[data-edit]");if(itEdit){const idx=Number(itEdit.getAttribute("data-edit"));if(Number.isFinite(idx))openEditorEdit(idx);return}const itDel=e.target.closest("button[data-del]");if(itDel){const idx=Number(itDel.getAttribute("data-del"));if(Number.isFinite(idx))delItem(idx);return}});document.addEventListener("keydown",e=>{if((Mode==="wizard"||Mode==="editheader")&&e.key==="Enter"){const a=document.activeElement;if(a&&a.id===ActiveFlow){e.preventDefault();confirmActive()}}});document.addEventListener("focusin",e=>{const t=e.target;if(!t||!t.id||!FlowOrder.includes(t.id))return;if(Mode==="idle"){try{t.blur()}catch(_){ }return}if(t.id!==ActiveFlow){setTimeout(()=>focusFlow(ActiveFlow),0)}});document.addEventListener("touchstart",()=>{if(Mode==="wizard"&&ActiveFlow==="InvoiceNumberInput")focusFlow("InvoiceNumberInput")},{once:true,passive:true});setMode("wizard");ActiveFlow=FlowOrder[0];updateWrappers();render();setTimeout(()=>focusFlow("InvoiceNumberInput"),200)})();
