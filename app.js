(()=>{const Items=[];let EditingIndex=-1;const USD="USD";const $=id=>document.getElementById(id);const parseNum=v=>{const s=String(v??"").trim().replaceAll(",","");const n=Number(s);return Number.isFinite(n)?n:NaN};const todayISO=()=>{const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");return `${y}-${m}-${day}`};const money=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:USD,minimumFractionDigits:2}).format(Number(n||0));const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");const totals=()=>Items.reduce((a,it)=>a+(it.qty*it.unitPrice),0);const setEditorMode=mode=>{const h=document.querySelector("#Editor h3");if(h)h.textContent=(mode==="edit"?"Editar √≠tem":"Nuevo √≠tem");const b=$("BtnFinishDesc");if(b)b.textContent=(mode==="edit"?"Guardar cambios":"Finalizar")};const render=()=>{const tbody=$("ItemsBody");tbody.innerHTML="";if(!Items.length){tbody.innerHTML='<tr><td class="empty" colspan="4">Sin √≠tems. Usa ‚ÄúAgregar √≠tem‚Äù.</td></tr>'}else{Items.forEach((it,i)=>{const tr=document.createElement("tr");tr.setAttribute("data-idx",String(i));tr.innerHTML=`<td><div class="item-title-row"><div class="item-title">${esc(it.title)}</div><div class="item-actions"><button type="button" class="edit-btn" data-edit="${i}">Editar</button><button type="button" class="delete-btn" data-del="${i}" title="Eliminar √≠tem" aria-label="Eliminar √≠tem">üóëÔ∏è</button></div></div><div class="item-desc">${esc(it.desc).replaceAll("\n","<br>")}</div></td><td class="r">${it.qty}</td><td class="r">${money(it.unitPrice)}</td><td class="r">${money(it.qty*it.unitPrice)}</td>`;tbody.appendChild(tr)})}const t=totals();$("Total").textContent=money(t);$("AmountDueTop").textContent=money(t);$("AmountDueBottom").textContent=money(t)};const openEditorAdd=()=>{EditingIndex=-1;setEditorMode("add");$("Editor").style.display="block";$("ItemTitle").value="";$("ItemDesc").value="";$("ItemTitle").focus()};const openEditorEdit=idx=>{const it=Items[idx];if(!it)return;EditingIndex=idx;setEditorMode("edit");$("Editor").style.display="block";$("ItemTitle").value=it.title;$("ItemDesc").value=it.desc;$("ItemTitle").focus()};const closeEditor=()=>{$("Editor").style.display="none";EditingIndex=-1;setEditorMode("add")};const finish=()=>{const title=$("ItemTitle").value.trim();const desc=($("ItemDesc").value??"").toString().trim();if(!title){alert("Falta el t√≠tulo del √≠tem.");$("ItemTitle").focus();return}if(!desc){alert("Falta la descripci√≥n del √≠tem.");$("ItemDesc").focus();return}let defaultQty="1",defaultUnit="0";if(EditingIndex>=0&&Items[EditingIndex]){defaultQty=String(Items[EditingIndex].qty);defaultUnit=String(Items[EditingIndex].unitPrice)}let qty=parseNum(prompt("Cantidad (Quantity):",defaultQty));if(!Number.isFinite(qty)||qty<=0){alert("Cantidad inv√°lida.");return}let unit=parseNum(prompt(`Valor unitario (Unit Price) en ${USD} (solo n√∫mero):`,defaultUnit));if(!Number.isFinite(unit)||unit<0){alert("Valor unitario inv√°lido.");return}if(EditingIndex>=0){Items[EditingIndex]={title,desc,qty,unitPrice:unit};closeEditor();render();return}Items.push({title,desc,qty,unitPrice:unit});closeEditor();render();const more=confirm("¬øDeseas registrar m√°s √≠tems?");if(more){openEditorAdd();return}const doPrint=confirm("¬øDeseas imprimir / guardar PDF ahora?");if(doPrint)window.print()};const delItem=idx=>{const it=Items[idx];if(!it)return;const ok=confirm(`¬øEliminar el √≠tem "${it.title}"?`);if(!ok)return;Items.splice(idx,1);if(EditingIndex===idx){closeEditor()}else if(EditingIndex>idx){EditingIndex-=1}render()};const FocusOrder=["InvoiceNumberInput","InvoiceDateInput","PaymentDueInput","BillToNameBoldInput","BillToLine1Input","BillToLine2Input","BillToLine3Input","BillToPhoneInput","BillToEmailInput"];const focusById=id=>{const el=$(id);if(!el)return;el.focus();try{el.scrollIntoView({behavior:"smooth",block:"center"})}catch(_){}};const focusNext=currentId=>{const i=FocusOrder.indexOf(currentId);if(i<0){focusById(FocusOrder[0]);return}if(i>=FocusOrder.length-1){const el=$(currentId);if(el)el.blur();return}focusById(FocusOrder[i+1])};const wireFocusFlow=()=>{FocusOrder.forEach((id,idx)=>{const el=$(id);if(!el)return;el.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();focusNext(id)}});if(el.tagName==="SELECT"||el.type==="date"){el.addEventListener("change",()=>focusNext(id))}});const btn=$("BtnNextField");if(btn)btn.addEventListener("click",()=>{const active=document.activeElement;const id=(active&&active.id)?active.id:"";focusNext(id||FocusOrder[0])})};$("InvoiceDateInput").value=todayISO();$("PaymentDueInput").value=todayISO();$("BtnAddGuided").addEventListener("click",openEditorAdd);$("BtnCancel").addEventListener("click",closeEditor);$("BtnFinishDesc").addEventListener("click",finish);$("BtnPrint").addEventListener("click",()=>window.print());$("ItemTitle").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();$("ItemDesc").focus()}});$("ItemsBody").addEventListener("click",e=>{const edit=e.target.closest("button[data-edit]");if(edit){const idx=Number(edit.getAttribute("data-edit"));if(Number.isFinite(idx))openEditorEdit(idx);return}const del=e.target.closest("button[data-del]");if(del){const idx=Number(del.getAttribute("data-del"));if(Number.isFinite(idx))delItem(idx);return}});wireFocusFlow();render();setTimeout(()=>focusById("InvoiceNumberInput"),150)})();
